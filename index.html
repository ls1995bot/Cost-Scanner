<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cost Scanner</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body { background-color: #000; margin: 0; display: flex; flex-direction: column; height: 100vh; font-family: 'Prompt', sans-serif; overflow: hidden; }
    
    /* Header */
    header { position: absolute; top: 0; width: 100%; padding: 15px; text-align: center; color: white; z-index: 20; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); }
    h3 { margin: 0; font-weight: 500; letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }

    /* Video Area */
    #video-container { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: #000; }
    video { width: 100%; height: 100%; object-fit: cover; }

    /* Overlay & Scan Line */
    .scan-frame {
        position: absolute; width: 80%; height: 100px;
        border: 2px solid rgba(255, 255, 255, 0.8);
        border-radius: 12px;
        box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.6); /* ‡∏â‡∏≤‡∏Å‡∏°‡∏∑‡∏î */
        z-index: 10; pointer-events: none;
    }
    .laser {
        width: 100%; height: 2px; background: #ff0000;
        box-shadow: 0 0 6px red;
        position: absolute; top: 50%;
        animation: scan 2s infinite;
    }
    @keyframes scan { 0% { transform: translateY(-40px); opacity: 0.5; } 50% { transform: translateY(40px); opacity: 1; } 100% { transform: translateY(-40px); opacity: 0.5; } }
    
    .guide-text { position: absolute; bottom: -40px; width: 100%; text-align: center; color: #fff; font-size: 14px; }

    /* Status Bar */
    .status-bar {
        background: #fff; padding: 20px; text-align: center;
        border-radius: 20px 20px 0 0; z-index: 20;
    }
    #status { font-size: 16px; color: #333; font-weight: 600; margin-bottom: 10px; }
    .btn-retry { background: #333; color: white; border: none; padding: 8px 20px; border-radius: 20px; display: none; }
  </style>
</head>
<body>

  <header>
    <h3>üí∞ LS SECRET SCAN</h3>
  </header>

  <div id="video-container">
    <div class="scan-frame">
        <div class="laser"></div>
        <div class="guide-text">‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</div>
    </div>
    <video id="video" autoplay muted playsinline></video>
  </div>

  <div class="status-bar">
    <div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...</div>
    <button class="btn-retry" onclick="location.reload()">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
  </div>

  <script>
    const LIFF_ID = "2008552223-7BjGxV6G"; 
    let codeReader = new ZXing.BrowserBarcodeReader();

    async function main() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) liff.login();
        startScan();
      } catch (err) {
        showError("LIFF Error: " + err);
      }
    }

    function startScan() {
      // ‡πÉ‡∏ä‡πâ Constraints ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á (Environment) ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ô‡∏µ‡πâ‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
      codeReader.decodeFromConstraints(
        { video: { facingMode: "environment" } }, 
        'video', 
        (result, err) => {
          if (result) {
            playSound();
            document.getElementById('status').innerText = "‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + result.text;
            document.getElementById('status').style.color = "green";
            
            if (liff.isInClient()) {
              liff.sendMessages([{ type: 'text', text: result.text }])
                .then(() => liff.closeWindow())
                .catch(e => showError("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"));
            } else {
              alert("Result: " + result.text);
            }
            codeReader.reset();
          }
        }
      ).catch(err => {
        showError("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err);
        document.querySelector('.btn-retry').style.display = 'inline-block';
      });
    }

    function showError(msg) {
      document.getElementById('status').innerText = msg;
      document.getElementById('status').style.color = "red";
    }

    function playSound() {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const g = ctx.createGain();
      osc.connect(g); g.connect(ctx.destination);
      osc.frequency.value = 1000; g.gain.value = 0.1;
      osc.start(); setTimeout(() => osc.stop(), 100);
    }

    main();
  </script>
</body>
</html>
